import{r as v,R as J,a as _,j as e,m as O,s as Qe,b as C,B as oe,v as E,l as T,c as w,M as De,f as V,I as Xe,J as de,i as I,K as Q,g as H,T as Me,H as ue,P as ye,C as es,A as $,q as ss,L as as,d as ns,k as ts,o as ls,p as is,Q as rs,U as os,e as cs}from"./index-DH1v9iOD.js";import{u as W,S as ds,A as us,a as Ne,b as R,E as A,P as z,c as ms}from"./SelectEnvironment-GfN4mjDu.js";import{u as j,a as Y,E as M}from"./plan-BC79Qq7e.js";import{B as S}from"./Banner-DFFgSp7_.js";import{V as L,F as ke,a as Pe,p as ps}from"./PlusCircleIcon-M3NGeHST.js";import{K as fs,L as $e,V as hs,y as xs,p as js,o as ce,$ as vs,W as gs,X as ys,_ as ws,Y as bs,a as Re,Z as Ns,z as se}from"./popover-BS2D7N_A.js";import{I as K}from"./Input-BGdTmRPV.js";import{H as ks,V as Ps,Q as Ts,w as Cs,u as Fs,a as As,l as Ss,T as Ds,N as Rs,U as Es,j as Bs,p as _s}from"./ListboxShow-BRUdoaSL.js";import{u as ze}from"./project-YuVl6ae5.js";import{F as we}from"./context-C6O7H5eL.js";import"./ModelLineage-BVQJptIB.js";import"./editor-DQqZC36D.js";import"./file-gUDWL5Z6.js";import"./SearchList-vj2s_Pnb.js";import"./help-6Q7f7fjd.js";import"./floating-ui.react-dom-9Mo3XjFw.js";import"./ChevronDownIcon-DtTgO9XQ.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";import"./SourceList-BioJ2XB9.js";import"./index-Ditw2lX8.js";function Os({title:s,titleId:a,...t},r){return v.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":a},t),s?v.createElement("title",{id:a},s):null,v.createElement("path",{fillRule:"evenodd",d:"M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z",clipRule:"evenodd"}))}const X=v.forwardRef(Os);let Te=v.createContext(null);Te.displayName="GroupContext";let Is=v.Fragment;function Ms(s){var a;let[t,r]=v.useState(null),[l,i]=Ts(),[c,u]=Cs(),o=v.useMemo(()=>({switch:t,setSwitch:r}),[t,r]),d={},m=s,n=$e();return J.createElement(u,{name:"Switch.Description",value:c},J.createElement(i,{name:"Switch.Label",value:l,props:{htmlFor:(a=o.switch)==null?void 0:a.id,onClick(h){t&&(hs(h.currentTarget)&&h.preventDefault(),t.click(),t.focus({preventScroll:!0}))}}},J.createElement(Te.Provider,{value:o},n({ourProps:d,theirProps:m,slot:{},defaultTag:Is,name:"Switch.Group"}))))}let $s="button";function zs(s,a){var t;let r=v.useId(),l=Fs(),i=As(),{id:c=l||`headlessui-switch-${r}`,disabled:u=i||!1,checked:o,defaultChecked:d,onChange:m,name:n,value:h,form:p,autoFocus:f=!1,...x}=s,F=v.useContext(Te),[B,D]=v.useState(null),N=v.useRef(null),k=xs(N,a,F===null?null:F.setSwitch,D),g=Ss(d),[P,Z]=Ds(o,m,g??!1),je=js(),[le,b]=v.useState(!1),ie=ce(()=>{b(!0),Z==null||Z(!P),je.nextFrame(()=>{b(!1)})}),re=ce(U=>{if(Ns(U.currentTarget))return U.preventDefault();U.preventDefault(),ie()}),ve=ce(U=>{U.key===Re.Space?(U.preventDefault(),ie()):U.key===Re.Enter&&_s(U.currentTarget)}),Le=ce(U=>U.preventDefault()),Ve=Rs(),Ge=Es(),{isFocusVisible:Fe,focusProps:He}=vs({autoFocus:f}),{isHovered:Ae,hoverProps:Ke}=gs({isDisabled:u}),{pressed:Se,pressProps:Ze}=ys({disabled:u}),qe=v.useMemo(()=>({checked:P,disabled:u,hover:Ae,focus:Fe,active:Se,autofocus:f,changing:le}),[P,Ae,Fe,Se,u,le,f]),We=ws({id:c,ref:k,role:"switch",type:bs(s,B),tabIndex:s.tabIndex===-1?0:(t=s.tabIndex)!=null?t:0,"aria-checked":P,"aria-labelledby":Ve,"aria-describedby":Ge,disabled:u||void 0,autoFocus:f,onClick:re,onKeyUp:ve,onKeyPress:Le},He,Ke,Ze),Ye=v.useCallback(()=>{if(g!==void 0)return Z==null?void 0:Z(g)},[Z,g]),Je=$e();return J.createElement(J.Fragment,null,n!=null&&J.createElement(Bs,{disabled:u,data:{[n]:h||"on"},overrides:{type:"checkbox",checked:P},form:p,onReset:Ye}),Je({ourProps:We,theirProps:x,slot:qe,defaultTag:$s,name:"Switch"}))}let Us=fs(zs),Ls=Ms,Vs=Ps,Gs=ks,ge=Object.assign(Us,{Group:Ls,Label:Vs,Description:Gs});function Hs(){const s=_(a=>a.environment);return e.jsx("div",{className:"flex flex-col px-4 py-2 w-full",children:e.jsx(S,{variant:O.Warning,children:e.jsx(L,{defaultOpen:!1,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(L.Button,{className:"w-full flex items-center justify-between",children:[e.jsx(S.Label,{className:"w-full",children:s.isInitialProd?"Initializing Prod Environment":"Prod Environment"}),s.isInitialProd&&e.jsx(e.Fragment,{children:a?e.jsx(ke,{className:"w-5 text-warning-500"}):e.jsx(Pe,{className:"w-5 text-warning-500"})})]}),s.isInitialProd&&e.jsx(L.Panel,{className:"px-2 text-sm mt-2",children:e.jsx(S.Description,{children:"Prod will be completely backfilled in order to ensure there are no data gaps. After this is applied, it is recommended to validate further changes in a dev environment before deploying to production."})})]})})})})}function Ks(s=0){return v.useCallback(a=>{setTimeout(()=>{a==null||a.focus()},s)},[s])}function Zs({run:s,apply:a,cancel:t,reset:r}){const l=Qe(),{change_categorization:i}=W(),c=_(b=>b.modules),u=_(b=>b.environment),o=_(b=>b.environments),d=_(b=>b.addConfirmation),m=_(b=>b.setShowConfirmation),n=j(b=>b.planAction),h=j(b=>b.planOverview),p=j(b=>b.planApply),f=j(b=>b.planCancel),x=Ks();function F(b){b.stopPropagation(),r()}function B(b){b.stopPropagation(),t()}function D(b){b.stopPropagation(),l(-1)}function N(b){b.stopPropagation();const ie=u.isProd&&C(u.isInitial),re=Array.from(i.values()).some(ve=>E(ve.category));ie?d({headline:"Applying Plan Directly On Prod Environment!",tagline:"Safer choice will be to select or add new environment first.",description:"Are you sure you want to apply your changes directly on prod?",yesText:`Yes, Run ${u.name}`,noText:"No, Cancel",action:a,details:re?["ATTENTION!","[Breaking Change] category will be applied to all uncategorized changes"]:void 0,children:e.jsxs("div",{className:"mt-5 pt-4",children:[e.jsx("h4",{className:"mb-2",children:`${o.size>1?"Select or ":""}Add Environment`}),e.jsxs("div",{className:"flex items-center relative",children:[o.size>1&&e.jsx(ds,{className:"mr-2",showAddEnvironment:!1,onSelect:()=>{m(!1)},size:T.md}),e.jsx(us,{className:"w-full",size:T.md,onAdd:()=>{m(!1)}})]})]})}):re?d({headline:"Some changes are missing categorization!",description:"Are you sure you want to proceed?",details:["[Breaking Change] category will be applied to all uncategorized changes"],yesText:"Yes, Apply",noText:"No, Cancel",action:a}):a()}function k(b){b.stopPropagation(),s()}const g=h.isFailed||p.isFailed||f.isSuccessful,P=C(n.isCancelling)&&C(n.isDone)&&(n.isProcessing?C(f.isSuccessful):!0)&&C(g),Z=n.isApplying||f.isCancelling||p.isRunning&&h.isFinished,je=g||C(n.isProcessing)&&C(n.isRun)&&C(n.isDone),le=c.showHistoryNavigation;return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex justify-between pt-2 pl-4 pr-2 pb-2",children:[e.jsx("div",{className:"flex w-full items-center",children:e.jsx(se,{appear:!0,show:P,enter:"transition ease duration-300 transform",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"transition ease duration-300 transform",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:"trasition-all duration-300 ease-in-out",as:"div",children:P&&e.jsx(oe,{disabled:n.isProcessing||f.isSuccessful||n.isDone,onClick:n.isRun?k:f.isSuccessful?void 0:N,ref:x,variant:f.isSuccessful?O.Danger:O.Primary,autoFocus:!0,className:"trasition-all duration-300 ease-in-out",children:e.jsx("span",{children:Y.getActionDisplayName(n,f.isSuccessful?[]:[M.RunningTask,M.Running,M.Run,M.Applying,M.ApplyBackfill,M.ApplyVirtual,M.ApplyChangesAndBackfill,M.ApplyMetadata],f.isSuccessful?"Canceled":"Done")})})})}),e.jsxs("div",{className:"flex items-center",children:[Z&&e.jsx(oe,{onClick:B,variant:O.Danger,disabled:n.isCancelling||n.isProcessing&&f.isSuccessful,children:Y.getActionDisplayName(n,n.isProcessing&&C(f.isSuccessful)?[M.Cancelling]:[],f.isSuccessful?"Finishing Cancellation...":"Cancel")}),je&&e.jsx(oe,{onClick:F,variant:O.Info,disabled:n.isCancelling||n.isProcessing&&f.isSuccessful,children:"Start Over"}),le&&e.jsx(oe,{onClick:D,variant:O.Info,children:"Go Back"})]})]})})}function qs({label:s,enabled:a,setEnabled:t,a11yTitle:r,size:l=T.md,disabled:i=!1,className:c}){return e.jsxs(ge.Group,{as:"div",className:"m-1",children:[e.jsxs(ge,{checked:i?!1:a,onChange:t,className:w("flex relative border-secondary-30 rounded-full m-0","shrink-0 focus:outline-none ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100 focus:border-secondary-500 focus-visible:ring-opacity-75","transition duration-200 ease-in-out",a?"bg-secondary-500":"bg-secondary-20",c,i?"opacity-50 cursor-not-allowed":"cursor-pointer",l===T.sm&&"h-[14px] w-6 focus:ring-1 border",l===T.md&&"h-5 w-10 focus:ring-2 border-2",l===T.lg&&"h-7 w-14 focus:ring-4 border-2"),disabled:i,children:[e.jsx("span",{className:"sr-only",children:r}),e.jsx("span",{"aria-hidden":"true",className:w("pointer-events-none inline-block transform rounded-full shadow-md transition duration-200 ease-in-out","bg-light",l===T.sm&&"h-3 w-3",l===T.md&&"h-4 w-4",l===T.lg&&"h-6 w-6",a&&l===T.sm&&"translate-x-[10px]",a&&l===T.md&&"translate-x-5",a&&l===T.lg&&"translate-x-7")})]}),s!=null&&e.jsx(ge.Label,{className:w("text-xs font-light ml-1 text-neutral-600 dark:text-neutral-400"),children:s})]})}function q({label:s,info:a,enabled:t,disabled:r=!1,setEnabled:l,className:i}){return e.jsxs("div",{className:w("flex justify-between",i),children:[e.jsxs("label",{className:"block mb-1 px-3 text-sm font-bold",children:[s,e.jsx("small",{className:"block text-xs text-neutral-500",children:a})]}),e.jsx(qs,{disabled:r,enabled:t,setEnabled:l,size:T.lg})]})}function Ws({disabled:s=!1,className:a}){const t=Ne(),{start:r,end:l,isInitialPlanRun:i}=W();return e.jsxs("div",{className:w("flex w-full flex-wrap md:flex-nowrap",a),children:[e.jsx(K,{className:"w-full md:w-[50%]",label:"Start Date (UTC)",info:"The start datetime of the interval",disabled:s||i,children:({disabled:c,className:u})=>e.jsx(K.Textfield,{className:w(u,"w-full"),disabled:c,placeholder:"2023-12-13",value:r,onInput:o=>{o.stopPropagation(),t({type:R.DateStart,start:o.target.value})}})}),e.jsx(K,{className:"w-full md:w-[50%]",label:"End Date (UTC)",info:"The end datetime of the interval",disabled:s||i,children:({disabled:c,className:u})=>e.jsx(K.Textfield,{className:w(u,"w-full"),disabled:c,placeholder:"2022-12-13",value:l,onInput:o=>{o.stopPropagation(),t({type:R.DateEnd,end:o.target.value})}})})]})}function Ys(){const s=Ne(),{skip_tests:a,no_gaps:t,skip_backfill:r,forward_only:l,auto_apply:i,no_auto_categorization:c,restate_models:u,isInitialPlanRun:o,create_from:d,include_unmodified:m}=W(),n=v.useRef(null),h=j(N=>N.planAction),p=j(N=>N.planOverview),f=j(N=>N.planApply),x=_(N=>N.environment),F=_(N=>N.environments),B=De.getOnlyRemote(Array.from(F));v.useEffect(()=>{s({type:R.PlanOptions,...p.plan_options,skip_tests:!1})},[]);const D=h.isProcessing||h.isDone||f.isFinished||p.isLatest&&C(h.isRun)||p.isVirtualUpdate;return v.useEffect(()=>{var N;E(n.current)||h.isProcessing&&n.current.classList.contains("--is-open")&&((N=n.current)==null||N.click())},[n,h]),e.jsxs("form",{className:"w-full",children:[e.jsx("fieldset",{className:w(D&&"opacity-50 cursor-not-allowed"),children:e.jsx(Ws,{className:w(D&&"pointer-events-none")})}),e.jsx("fieldset",{className:"my-2",children:e.jsx(S,{children:e.jsx(L,{defaultOpen:h.isRun,children:({open:N})=>e.jsxs(e.Fragment,{children:[e.jsxs(L.Button,{ref:n,className:w("w-full flex items-center",N&&"--is-open"),children:[e.jsxs(S.Label,{className:"mr-2 text-sm w-full",children:[e.jsx("span",{children:"Additional Options"}),D&&e.jsx("span",{className:"ml-1",children:"(Read Only)"})]}),N?e.jsx(ke,{className:"h-5 w-5 text-neutral-400"}):e.jsx(Pe,{className:"h-5 w-5 text-neutral-400"})]}),e.jsxs(L.Panel,{unmount:!1,className:w("py-4 text-sm text-neutral-500",D&&"opacity-50 cursor-not-allowed"),children:[e.jsx("div",{className:w(D&&"pointer-events-none"),children:e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap",children:[C(x.isProd)&&e.jsx(K,{className:"w-full",label:"Create From Environment",info:"The environment to base the plan on rather than local files",disabled:B.length<2,children:({className:k,disabled:g})=>e.jsx(K.Selector,{className:w(k,"w-full"),list:De.getOnlyRemote(Array.from(F)).filter(P=>P!==x).map(P=>({value:P.name,text:P.name})),onChange:P=>{s({type:R.PlanOptions,create_from:P})},value:d,disabled:g})}),e.jsx(K,{className:"w-full",label:"Restate Models",info:`Restate data for specified models and models
                    downstream from the one specified. For production
                    environment, all related model versions will have
                    their intervals wiped, but only the current
                    versions will be backfilled. For development
                    environment, only the current model versions will
                    be affected`,children:({className:k})=>e.jsx(K.Textfield,{className:w(k,"w-full"),placeholder:"project.model1, project.model2",disabled:o,value:u??"",onInput:g=>{g.stopPropagation(),s({type:R.PlanOptions,restate_models:g.target.value})}})})]})}),e.jsxs("div",{className:w("flex flex-wrap md:flex-nowrap w-full mt-3",D&&"pointer-events-none"),children:[e.jsxs("div",{className:"w-full md:mr-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(q,{label:"Skip Tests",info:`Skip tests prior to generating the plan if they
              are defined`,enabled:!!a,setEnabled:k=>{s({type:R.PlanOptions,skip_tests:k})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(q,{label:"No Gaps",info:`Ensure that new snapshots have no data gaps when
              comparing to existing snapshots for matching
              models in the target environment`,enabled:!!t||!!r&&x.isInitialProd||x.isInitialProd,disabled:o||!!r&&x.isInitialProd||x.isInitialProd,setEnabled:k=>{s({type:R.PlanOptions,no_gaps:k})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(q,{label:"Skip Backfill",info:"Skip the backfill step",enabled:!!r,disabled:o||x.isInitialProd,setEnabled:k=>{s({type:R.PlanOptions,skip_backfill:k})}})})]}),e.jsxs("div",{className:"w-full md:ml-2",children:[e.jsxs("div",{className:"block my-2",children:[e.jsx(q,{label:"Include Unmodified",info:"Indicates whether to create views for all models in the target development environment or only for modified ones",enabled:!!m,disabled:o||x.isInitialProd,setEnabled:k=>{s({type:R.PlanOptions,include_unmodified:k})}}),e.jsx(q,{label:"Forward Only",info:"Create a plan for forward-only changes",enabled:!!l,disabled:o||x.isInitialProd,setEnabled:k=>{s({type:R.PlanOptions,forward_only:k})}})]}),e.jsx("div",{className:"block my-2",children:e.jsx(q,{label:"Auto Apply",info:"Automatically apply the plan after it is generated",enabled:!!i,setEnabled:k=>{s({type:R.PlanOptions,auto_apply:k})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(q,{label:"No Auto Categorization",info:"Set category manually",enabled:!!c,disabled:o||x.isInitialProd,setEnabled:k=>{s({type:R.PlanOptions,no_auto_categorization:k})}})})]})]})]})]})},String(h.isRun))})})]})}function Js(s){const{start:a,end:t,skip_tests:r,no_gaps:l,skip_backfill:i,forward_only:c,include_unmodified:u,no_auto_categorization:o,restate_models:d,auto_apply:m,create_from:n,change_categorization:h}=W(),p=_(D=>D.environment),f=E(p==null?void 0:p.isDefault)||V(p==null?void 0:p.isDefault),x=v.useMemo(()=>{if(!p.isProd)return{start:a,end:f&&Xe(d)?void 0:t}},[p,a,t,f,d]),F=v.useMemo(()=>p.isInitialProd?{include_unmodified:!0,no_gaps:!0,skip_tests:r,auto_apply:m}:{skip_tests:r,no_gaps:l,skip_backfill:i,forward_only:c,create_from:n,no_auto_categorization:o,restate_models:d,include_unmodified:u,auto_apply:m},[p,l,i,c,u,n,o,r,d,m]),B=v.useMemo(()=>Array.from(h.values()).reduce((D,{category:N,change:k})=>(D[k.displayName]=(N==null?void 0:N.value)??de.NUMBER_1,D),{}),[h]);return{planOptions:{...F,...s},planDates:x,categories:B}}function Qs(){const{start:s,end:a,skip_tests:t,no_gaps:r,skip_backfill:l,forward_only:i,include_unmodified:c,no_auto_categorization:u,restate_models:o,create_from:d,change_categorization:m}=W(),n=_(x=>x.environment),h=E(n==null?void 0:n.isDefault)||V(n==null?void 0:n.isDefault),p=v.useMemo(()=>{if(!h)return{start:s,end:a}},[s,a,h]),f=v.useMemo(()=>Array.from(m.values()).reduce((x,{category:F,change:B})=>(x[B.displayName]=(F==null?void 0:F.value)??de.NUMBER_1,x),{}),[m]);return{planDates:p,planOptions:{no_gaps:r,skip_backfill:l,forward_only:i,include_unmodified:c,create_from:d,no_auto_categorization:u,skip_tests:t,restate_models:o},categories:f}}function ee(s,a,t){var c;const r=(s.isFinished&&(a.isLatest||a.isRunning)||t.isFinished||C((c=s.overview)==null?void 0:c.isFailed))&&I(s.overview),l=r?s.overview:a,i=r?s:a;return{meta:i.meta,start:i.start,end:i.end,hasChanges:l.hasChanges,hasBackfills:l.hasBackfills,backfills:i.backfills??[],added:i.added??[],removed:i.removed??[],direct:i.direct??[],indirect:i.indirect??[],metadata:i.metadata??[],plan_options:i.plan_options,stageValidation:i.stageValidation,stageBackfills:i.stageBackfills,stageChanges:i.stageChanges,isFailed:l.isFailed||t.isFailed||s.isFailed}}const Ee=3;function ae({progress:s=0,delay:a=0,duration:t=0,startFromZero:r=!0,className:l}){return C(r)&&(s=s<Ee?Ee:s),e.jsx("div",{className:w("w-full h-1 bg-neutral-30 overflow-hidden flex items-center rounded-lg my-1",l),children:e.jsx("div",{className:"transition-[width] h-full bg-success-500 rounded-lg",style:{width:`${s}%`,transitionDelay:`${a}ms`,transitionDuration:`${t}ms`}})})}const y=function({children:a,setRefTasksOverview:t,tasks:r}){const{models:l,taskCompleted:i,taskTotal:c,batchesTotal:u,batchesCompleted:o}=v.useMemo(()=>{const d=Object.values(r),m=d.length;let n=0,h=0,p=0;return d.forEach(f=>{n=f.completed===f.total?n+1:n,h+=f.total,p+=f.completed}),{models:d,taskCompleted:n,taskTotal:m,batchesTotal:h,batchesCompleted:p}},[r]);return e.jsx("div",{className:"text-prose",ref:t,children:a({models:l,completed:i,total:c,totalBatches:u,completedBatches:o})})};function Xs({className:s,headline:a,environment:t,completed:r,total:l,updatedAt:i,updateType:c,completedBatches:u,totalBatches:o}){return e.jsx(Ce,{className:s,children:e.jsxs(me,{children:[e.jsxs(pe,{children:[e.jsx(fe,{children:e.jsx(Ue,{headline:a,environment:t})}),e.jsxs(he,{children:[e.jsx(ne,{completed:r,total:l,unit:"task"}),e.jsx(te,{}),e.jsx(ne,{completed:u,total:o,unit:"batches"}),e.jsx(te,{}),e.jsx(xe,{completed:u,total:o})]})]}),e.jsx(ae,{progress:Q(u,o)}),I(i)&&e.jsx(sa,{updatedAt:i,updateType:c})]})})}function ea({models:s,className:a,added:t,removed:r,direct:l,indirect:i,metadata:c,showBatches:u=!0,showProgress:o=!0,showVirtualUpdate:d=!1,queue:m}){return e.jsxs(e.Fragment,{children:[e.jsx(se,{show:H(m),enter:"transition ease duration-300 transform",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"transition ease duration-300 transform",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:"trasition-all duration-300 ease-in-out",as:"div",children:e.jsxs("div",{className:"px-4 pt-3 pb-2 mt-4 shadow-lg rounded-lg",children:[e.jsx(Me,{text:"Currently in proccess"}),e.jsx(be,{models:m,children:n=>e.jsxs(me,{children:[e.jsxs(pe,{children:[e.jsxs(fe,{children:[H(n.interval)&&e.jsx(Be,{start:n.interval[0],end:n.interval[1]}),e.jsx(Oe,{modelName:n.displayViewName,changeType:Ie({modelName:n.name,added:t,removed:r,direct:l,indirect:i,metadata:c})})]}),e.jsxs(he,{children:[u&&e.jsx(ne,{completed:n.completed,total:n.total,unit:"batch"}),e.jsx(te,{}),o&&e.jsx(e.Fragment,{children:E(n.end)||E(n.start)?e.jsx(xe,{total:n.total,completed:n.completed}):e.jsx(_e,{start:n.start,end:n.end})}),d&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),o?e.jsx(ae,{startFromZero:!1,progress:Q(n.completed,n.total)}):e.jsx(ue,{className:"my-1 border-neutral-200 opacity-50"})]})})]})}),e.jsx(Ce,{className:a,children:e.jsx(be,{models:s,children:n=>e.jsxs(me,{children:[e.jsxs(pe,{children:[e.jsxs(fe,{children:[H(n.interval)&&e.jsx(Be,{start:n.interval[0],end:n.interval[1]}),e.jsx(Oe,{modelName:n.displayViewName,changeType:Ie({modelName:n.name,added:t,removed:r,direct:l,indirect:i,metadata:c})})]}),e.jsxs(he,{children:[u&&e.jsx(ne,{completed:n.completed,total:n.total,unit:"batch"}),e.jsx(te,{}),o&&e.jsx(e.Fragment,{children:E(n.end)||E(n.start)?e.jsx(xe,{total:n.total,completed:n.completed}):e.jsx(_e,{start:n.start,end:n.end})}),d&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),o?e.jsx(ae,{progress:Q(n.completed,n.total),startFromZero:m.findIndex(h=>h.name===n.name)===-1}):e.jsx(ue,{className:"my-1 border-neutral-200 opacity-50"})]})})})]})}function Ce({className:s,children:a}){return e.jsx("div",{className:w("max-h-[50vh] overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:a})}function me({className:s,children:a}){return e.jsx("div",{className:w("px-2",s),children:a})}function be({className:s,models:a,children:t}){return e.jsx("ul",{className:w("rounded-lg pt-4 overflow-auto text-prose hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:a.map(r=>e.jsx("li",{className:"mb-2",children:t(r)},r.name))})}function pe({className:s,children:a}){return e.jsx("div",{className:w("flex sm:justify-between sm:items-baseline text-xs",s),children:a})}function Ue({className:s,headline:a,environment:t}){return e.jsxs("span",{className:w("flex items-center",s),children:[e.jsx("span",{className:"block whitespace-nowrap text-sm font-medium",children:a}),I(t)&&e.jsx("small",{className:"inline-block ml-1 px-2 py-[0.125rem] text-xs font-bold bg-neutral-10 rounded-md",children:t})]})}function fe({className:s,children:a}){return e.jsx("div",{className:w("flex mr-6 w-full sm:w-auto overflow-hidden",s),children:a})}function he({className:s,children:a}){return e.jsx("div",{className:w("flex items-center",s),children:a})}function Be({className:s,start:a,end:t}){return e.jsxs("span",{className:w("inline-block mr-2 whitespace-nowrap font-mono",s),children:[a," – ",t]})}function ne({className:s,total:a,completed:t,unit:r}){return e.jsxs("span",{className:w("inline-block whitespace-nowrap",s),children:[t," of ",a," ",ps(r,a)]})}function te({className:s}){return e.jsx("span",{className:w("inline-block mx-2",s),children:"|"})}function xe({className:s,total:a,completed:t}){return e.jsxs("span",{className:w("inline-block whitespace-nowrap font-bold",s),children:[Math.ceil(Q(t,a)),"%"]})}function _e({className:s,start:a,end:t}){return e.jsx("span",{className:w("inline-block whitespace-nowrap font-bold",s),children:`${Math.floor((t-a)/6e4)}:${String(Math.ceil((t-a)/1e3%60)).padStart(2,"0")}`})}function sa({updateType:s,updatedAt:a}){return e.jsxs("div",{className:"flex justify-between mt-1",children:[e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Update Type:"}),e.jsx("span",{className:"inline-block ml-1",children:s})]}),e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Last Update:"}),e.jsx("span",{className:"inline-block ml-1",children:ye(new Date(a),"yyyy-mm-dd hh-mm-ss",!1)})]})]})}function Oe({className:s,modelName:a,changeType:t}){return e.jsx("span",{className:w("font-bold whitespace-nowrap",t===A.Add&&"text-success-600  dark:text-success-500",t===A.Remove&&"text-danger-500",t===A.Direct&&"text-secondary-500 dark:text-primary-500",t===A.Indirect&&"text-warning-500",t===A.Default&&"text-prose",s),children:a})}y.Block=Ce;y.Summary=Xs;y.Details=ea;y.DetailsProgress=he;y.Task=me;y.Tasks=be;y.TaskDetails=pe;y.TaskProgress=xe;y.TaskSize=ne;y.TaskDivider=te;y.TaskInfo=fe;y.TaskHeadline=Ue;function Ie({modelName:s,added:a,removed:t,direct:r,indirect:l,metadata:i}){return a.some(c=>c.name===s)?A.Add:t.some(c=>c.name===s)?A.Remove:r.some(c=>c.name===s)?A.Direct:l.some(c=>c.name===s)?A.Indirect:i.some(c=>c.name===s)?A.Metadata:A.Default}function aa({report:s}){var a;return e.jsxs("div",{children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("p",{children:["Total: ",s.total]}),e.jsxs("p",{children:["Succeeded: ",s.successful]}),e.jsxs("p",{children:["Failed: ",s.failures]}),e.jsxs("p",{children:["Errors: ",s.errors]}),e.jsxs("p",{children:["Dialect: ",s.dialect]})]}),e.jsx("ul",{children:(a=s.details)==null?void 0:a.map(t=>e.jsxs("li",{className:"flex mb-1",children:[e.jsx("span",{className:"inline-block mr-4",children:"—"}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("span",{className:"inline-block mb-2",children:t.message}),e.jsx("code",{className:"inline-block max-h-[50vh] bg-theme py-2 px-4 rounded-lg w-full overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",children:e.jsx("pre",{children:t.details})})]})]},t.message))})]})}function na(){var f;const s=ze(x=>x.tests),a=j(x=>x.planApply),t=j(x=>x.planOverview),r=j(x=>x.planCancel),l=j(x=>x.planAction),{plan_options:i,hasChanges:c,hasBackfills:u,isFailed:o}=ee(a,t,r),d=I(s)&&!!s.total,m=I(s)&&!!s.message&&C(d),n=I(s)&&(!!s.failures||!!s.errors),h=C(l.isProcessing)&&C(l.isDone)&&C(r.isFinished),p=o&&[n,d,c,u].every(es);return e.jsx(se,{appear:!0,show:C(l.isRun),enter:"transition ease duration-300 transform",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"transition ease duration-300 transform",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:w("my-2 rounded-xl",o&&"bg-danger-5"),as:"div",children:p?e.jsxs(S,{className:"flex items-center",size:T.sm,variant:O.Danger,children:[e.jsx(we,{className:"w-4 mr-2"}),e.jsx(S.Label,{className:"mr-2 text-sm",children:"Plan Failed"})]}):e.jsxs(e.Fragment,{children:[o&&e.jsxs(S,{className:"flex items-center mb-1",size:T.sm,variant:O.Danger,children:[e.jsx(we,{className:"w-4 mr-2"}),e.jsx(S.Label,{className:"mr-2 text-sm",children:"Plan Failed"})]}),V(i==null?void 0:i.skip_tests)?e.jsxs(S,{className:"flex items-center mb-1",size:T.sm,hasBackground:!1,children:[e.jsx(X,{className:"w-4 mr-2"}),e.jsx(S.Label,{className:"mr-2 text-sm",children:"Tests Skipped"})]}):d?e.jsx(ra,{isOpen:!0,report:s}):m?e.jsx(ia,{report:s}):e.jsxs(S,{className:"flex items-center mb-1",size:T.sm,hasBackground:!1,children:[e.jsx(X,{className:"w-4 mr-2"}),e.jsx(S.Label,{className:"mr-2 text-sm",children:"No Tests"})]}),C(n)&&e.jsxs(e.Fragment,{children:[e.jsx(ta,{isOpen:h}),e.jsx(la,{isOpen:h}),e.jsx(pa,{}),a.shouldShowEvaluation&&e.jsxs(oa,{start:a.evaluationStart,end:a.isFinished?a.evaluationEnd??((f=r.meta)==null?void 0:f.end):void 0,children:[e.jsx(ca,{}),e.jsx(da,{}),e.jsx(ua,{}),e.jsx(ma,{})]})]})]})})}function ta({isOpen:s=!1}){var d;const a=j(m=>m.planApply),t=j(m=>m.planOverview),r=j(m=>m.planCancel),{meta:l,stageChanges:i,hasChanges:c}=ee(a,t,r),u=(i==null?void 0:i.meta)??l;return ss([$.init,$.fail],(d=i==null?void 0:i.meta)==null?void 0:d.status)||V(c)?e.jsx(G,{meta:u,states:["Changes","Failed Getting Changes","Getting Changes..."],isOpen:s&&V(c),panel:e.jsx(fa,{})}):e.jsxs(S,{className:"flex items-center mb-1",size:T.sm,hasBackground:!1,children:[e.jsx(X,{className:"w-4 mr-2"}),e.jsx(S.Label,{className:"mr-2 text-sm",children:"No Changes"})]})}function la({isOpen:s=!1}){const{change_categorization:a}=W(),t=j(p=>p.planApply),r=j(p=>p.planOverview),l=j(p=>p.planCancel),{meta:i,stageBackfills:c,backfills:u,hasBackfills:o}=ee(t,r,l),d=(c==null?void 0:c.meta)??i,m=v.useMemo(()=>Array.from(a.values()).reduce((p,{category:f,change:x})=>{var F;return(f==null?void 0:f.value)!==de.NUMBER_3&&p.add(x.name),(E(f)||f.value===de.NUMBER_1)&&((F=x.indirect)==null||F.forEach(B=>p.add(B.name))),p},new Set),[a]),n=v.useMemo(()=>a.size>0?u.filter(p=>m.has(p.name)):u,[u,m]);return((d==null?void 0:d.status)===$.init||V(o))&&(a.size>0?n.length>0:!0)?e.jsx(G,{meta:d,states:["Backfills","Failed Getting Backfills","Getting Backfills..."],isOpen:s&&V(o),panel:e.jsx(z,{headline:`Models ${n.length}`,type:A.Default,children:e.jsx(z.Default,{type:A.Default,changes:n})})}):e.jsxs(S,{className:"flex items-center mb-1",size:T.sm,hasBackground:!1,children:[e.jsx(X,{className:"w-4 mr-2"}),e.jsx(S.Label,{className:"mr-2 text-sm",children:"No Backfills"})]})}function ia({report:s}){return e.jsx(G,{meta:{status:$.success,...s},states:["Tests Completed","Failed Tests","Running Tests..."],children:s.message})}function ra({report:s,isOpen:a=!1}){return e.jsx(G,{variant:O.Danger,meta:{status:$.fail,...s},isOpen:a,states:["Tests Failed","One or More Tests Failed","Running Tests..."],shouldCollapse:!1,children:e.jsx(aa,{report:s})})}function oa({start:s,end:a,children:t}){const r=v.useRef(null);return v.useEffect(()=>{setTimeout(()=>{var l;(l=r.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})},500)},[]),E(s)?e.jsx(e.Fragment,{}):e.jsxs("div",{ref:r,className:"pt-4 pb-2 text-xs",children:[e.jsxs("span",{className:"text-neutral-500 block px-4 mb-1",children:["Evaluation started at"," ",ye(new Date(s),"yyyy-mm-dd hh-mm-ss")]}),e.jsx(ue,{}),e.jsx("div",{className:"py-2",children:t}),I(a)&&e.jsxs(e.Fragment,{children:[e.jsx(ue,{}),e.jsxs("span",{className:"text-neutral-500 block px-4 mt-1",children:["Evaluation stopped at"," ",ye(new Date(a),"yyyy-mm-dd hh-mm-ss")]})]})]})}function ca({isOpen:s}){var t;const a=j(r=>r.planApply);return E(a.stageCreation)?e.jsx(e.Fragment,{}):e.jsx(G,{meta:(t=a.stageCreation)==null?void 0:t.meta,states:["Snapshot Tables Created","Snapshot Tables Creation Failed","Creating Snapshot Tables..."],isOpen:s,children:e.jsx(y.Block,{children:e.jsxs(y.Task,{children:[e.jsxs(y.TaskDetails,{children:[e.jsx(y.TaskInfo,{children:e.jsx(y.TaskHeadline,{headline:"Snapshot Tables"})}),e.jsxs(y.DetailsProgress,{children:[e.jsx(y.TaskSize,{completed:a.stageCreation.num_tasks,total:a.stageCreation.total_tasks,unit:"task"}),e.jsx(y.TaskDivider,{}),e.jsx(y.TaskProgress,{completed:a.stageCreation.num_tasks,total:a.stageCreation.total_tasks})]})]}),e.jsx(ae,{progress:Q(a.stageCreation.num_tasks,a.stageCreation.total_tasks)})]})})})}function da(){var a;const s=j(t=>t.planApply);return E(s.stageRestate)?e.jsxs(S,{className:"flex items-center mb-1",size:T.sm,hasBackground:!1,children:[e.jsx(X,{className:"w-4 mr-2"}),e.jsx(S.Label,{className:"mr-2 text-sm",children:"No Models To Restate"})]}):e.jsx(G,{meta:(a=s.stageRestate)==null?void 0:a.meta,states:["Restate Models","Restate Models Failed","Restating Models..."]})}function ua(){const s=j(d=>d.planApply),a=j(d=>d.planAction),t=j(d=>d.planOverview),r=j(d=>d.planCancel),l=s.environment,i=s.stageBackfill,{backfills:c}=ee(s,t,r),u=v.useMemo(()=>Object.values(s.tasks).reduce((d,m)=>{const n=c.find(h=>h.name===m.name);return m.interval=(n==null?void 0:n.interval)??[],d[m.name]=m,d},{}),[c,s.tasks]);return I(i)&&I(l)?e.jsx(G,{meta:i.meta,states:["Backfilled","Backfilling Failed","Backfilling Intervals..."],showDetails:!0,isOpen:!0,shouldCollapse:!1,children:e.jsx(y,{tasks:u,children:({total:d,completed:m,models:n,completedBatches:h,totalBatches:p})=>e.jsxs(e.Fragment,{children:[e.jsx(y.Summary,{headline:"Target Environment",environment:l,completed:m,total:d,completedBatches:h,totalBatches:p,updateType:a.isApplyVirtual?"Virtual":"Backfill"}),I(n)&&e.jsx(y.Details,{models:n,added:s.added,removed:s.removed,direct:s.direct,indirect:s.indirect,metadata:s.metadata,queue:s.queue,showBatches:!0,showVirtualUpdate:a.isApplyVirtual,showProgress:!0})]})})}):e.jsx(e.Fragment,{})}function ma(){var a;const s=j(t=>t.planApply);return E(s.stagePromote)?e.jsx(e.Fragment,{}):e.jsx("div",{children:e.jsx(G,{meta:(a=s.stagePromote)==null?void 0:a.meta,states:["Environment Promoted","Promotion Failed","Promoting Environment..."],children:e.jsx(y.Block,{children:e.jsxs(y.Task,{children:[e.jsxs(y.TaskDetails,{children:[e.jsx(y.TaskInfo,{children:e.jsx(y.TaskHeadline,{headline:`Promote Environment: ${s.stagePromote.target_environment}`})}),e.jsxs(y.DetailsProgress,{children:[e.jsx(y.TaskSize,{completed:s.stagePromote.num_tasks,total:s.stagePromote.total_tasks,unit:"task"}),e.jsx(y.TaskDivider,{}),e.jsx(y.TaskProgress,{completed:s.stagePromote.num_tasks,total:s.stagePromote.total_tasks})]})]}),e.jsx(ae,{progress:Q(s.stagePromote.num_tasks,s.stagePromote.total_tasks)})]})})})})}function pa(){var u;const{virtualUpdateDescription:s}=W(),a=j(o=>o.planApply),t=j(o=>o.planOverview),r=j(o=>o.planCancel),{isFailed:l}=ee(a,t,r),i=((u=a.overview)==null?void 0:u.isVirtualUpdate)??t.isVirtualUpdate,c=V(a.isFinished);return i&&C(l)?e.jsx(G,{meta:{status:$.success,done:c},states:[c?"Virtual Update Completed":"Virtual Update","Virtual Update Failed","Applying Virtual Update..."],children:s}):e.jsx(e.Fragment,{})}function fa(){const s=j(n=>n.planAction),a=j(n=>n.planOverview),t=j(n=>n.planApply),r=j(n=>n.planCancel),{hasChanges:l,added:i,removed:c,direct:u,indirect:o,metadata:d}=ee(t,a,r),m=s.isProcessing||s.isDone||t.isFinished||a.isLatest&&C(s.isRun)||a.isVirtualUpdate;return e.jsx("div",{className:"w-full my-2",children:V(l)&&e.jsxs(e.Fragment,{children:[H(i)&&e.jsx(z,{className:"w-full my-2",headline:"Added Models",type:A.Add,children:e.jsx(z.Default,{type:A.Add,changes:i})}),H(c)&&e.jsx(z,{className:"w-full my-2",headline:"Removed Models",type:A.Remove,children:e.jsx(z.Default,{type:A.Remove,changes:c})}),H(u)&&e.jsx(z,{className:"my-2 w-full",headline:"Modified Directly",type:A.Direct,children:e.jsx(z.Direct,{changes:u,disabled:m})}),H(o)&&e.jsx(z,{className:"my-2 w-full",headline:"Modified Indirectly",type:A.Indirect,children:e.jsx(z.Indirect,{changes:o})}),H(d)&&e.jsx(z,{className:"my-2 w-full",headline:"Modified Metadata",type:A.Default,children:e.jsx(z.Default,{type:A.Default,changes:d})})]})})}function G({meta:s,states:a=["Success","Failed","Running"],isOpen:t=!1,trigger:r,panel:l,children:i,showDetails:c=!0,shouldCollapse:u=!0}){const o=v.useRef(null),d=j(P=>P.planOverview),m=j(P=>P.planApply),n=(s==null?void 0:s.status)!==$.fail&&I(l)||I(i),[h,p]=v.useState(t);v.useEffect(()=>{var P;E(o.current)||u&&(m.isFinished||d.isLatest)&&o.current.classList.contains("--is-open")&&((P=o.current)==null||P.click())},[o,d,m,u]),v.useEffect(()=>{p(t&&n)},[t,n]);const f=(s==null?void 0:s.status)===$.fail,x=(s==null?void 0:s.status)===$.success,F=(s==null?void 0:s.status)===$.init,B=x?O.Success:f?O.Danger:O.Info,[D,N,k]=a,g=x?D:f?N:k;return e.jsx(se,{appear:!0,show:I(s),enter:"transition ease duration-300 transform",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"transition ease duration-300 transform",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:"my-2",as:"div",children:e.jsxs(L,{children:[e.jsx(S,{className:"mb-1",variant:B,size:T.sm,hasBackground:!1,hasBackgroundOnHover:n,children:e.jsx(L.Button,{ref:o,className:w("w-full flex flex-col",h&&"--is-open",C(n)&&"cursor-default"),onClick:()=>p(P=>!P),children:E(r)?e.jsxs(e.Fragment,{children:[F&&e.jsx(as,{text:g,hasSpinner:!0,size:T.sm,variant:O.Primary,className:"w-full"}),C(F)&&e.jsxs("div",{className:"flex items-center h-full",children:[c&&n?e.jsx(e.Fragment,{children:h?e.jsx(ke,{className:"w-4 mr-2"}):e.jsx(Pe,{className:"w-4 mr-2"})}):e.jsxs(e.Fragment,{children:[(s==null?void 0:s.status)===$.success&&e.jsx(X,{className:"min-w-4 max-w-4 mr-2"}),(s==null?void 0:s.status)===$.fail&&e.jsx(we,{className:"min-w-4 max-w-4 mr-2"})]}),e.jsx(S.Label,{className:"mr-2 text-sm",children:e.jsx(Me,{text:g,size:T.sm,variant:B})})]})]}):r})}),e.jsx(se,{appear:!0,show:h,enter:"transition ease duration-300 transform",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"transition ease duration-300 transform",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:"trasition-all duration-300 ease-in-out",as:"div",children:e.jsxs(L.Panel,{static:!0,className:"px-2 text-xs mb-2",children:[I(i)&&e.jsx("div",{className:w("p-4 rounded-md",B===O.Danger?"bg-danger-5 text-danger-500":"bg-neutral-5"),children:i}),(s==null?void 0:s.status)!==$.fail&&l]})})]})})}function ha(){const s=Ne(),{clearErrors:a}=ns(),t=_(g=>g.environment),r=j(g=>g.planAction),l=j(g=>g.setPlanAction),i=j(g=>g.resetPlanTrackers),c=j(g=>g.resetPlanCancel),u=j(g=>g.clearPlanApply),o=ze(g=>g.setTests),d=Js(),m=Qs(),{refetch:n,cancel:h}=ts(t.name,d),{refetch:p,cancel:f}=ls(t.name,m),{refetch:x}=is();function F(){a(),s([{type:R.ResetPlanDates},{type:R.ResetPlanOptions},{type:R.ResetTestsReport},{type:R.ResetCategories}])}function B(){l(new Y({value:M.Run})),u(),F(),setTimeout(()=>i(),500)}function D(){l(new Y({value:M.Cancelling})),c(),s([{type:R.ResetTestsReport}]);let g;r.isApplying?g=h:g=f,g(),x()}function N(){l(new Y({value:M.Applying})),u(),s([{type:R.ResetTestsReport}]),p().catch(console.log)}function k(){l(new Y({value:M.Running})),i(),o(void 0),s([{type:R.ResetTestsReport}]),n().catch(console.log)}return e.jsxs("div",{className:"flex flex-col w-full h-full max-w-[80rem]",children:[t.isProd&&e.jsx(Hs,{}),e.jsxs("div",{className:"relative w-full h-full flex flex-col pt-2 pl-4 pr-2 overflow-y-scroll hover:scrollbar scrollbar--vertical",children:[e.jsx(Ys,{}),e.jsx(na,{})]}),e.jsx(Zs,{apply:N,run:k,cancel:D,reset:B})]})}function Oa(){const{environmentName:s}=rs(),a=_(l=>l.environment),t=_(l=>l.environments),r=_(l=>l.setEnvironment);return v.useEffect(()=>{if(a.isInitialProd||s===a.name)return;const l=Array.from(t).find(i=>i.name===s);E(l)||r(l)},[s]),e.jsx(ms,{children:E(a)?e.jsx(os,{link:cs.Plan,description:E(s)?void 0:`Environment ${s} Does Not Exist`,message:"Back To Data Catalog"}):e.jsx(ha,{})})}export{Oa as default};
